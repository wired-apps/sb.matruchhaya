<html>
    <head>
    </head>

   <body onload="afterPageLoad()">

  <div class="container">

    <!-- Success UI -->
    <div  id="successUI">
      <div >
        <h2>Receipt Summary</h2>
        <div id="paymentDiv"><p ><strong>Payment ID:</strong> <span id="paymentId"></span></p></div>
        <p id="amnt"><strong>Amount:</strong> <span id="amount"></span></p>
        <p><strong>Response:</strong> <span id="paymentResponse"></span></p>
      </div>
      <div id="recurringInfo" style="display:none;">
      <div  id="period" >
        <p><strong>Frequency:</strong> <span id="installPeriod"></span></p>
      </div>

      <div  id="establishdate">
        <p><strong>Start Date:</strong> <span id="establishmentDate"></span></p>
      </div>

      <div id="nextdate">
        <p><strong>Next Installment Date:</strong> <span id="nextInstallmentDate"></span></p>
      </div>

    </div>
    </div>

    <!-- Error UI -->
    <div id="errorUI" style="display:none;">
      <div >
        <p><strong>Reason:</strong> <span id="paymentResponseErr"></span></p>
      </div>

      <div id="retryBtn">
        <ul><ul>
            <li><a href=''>Retry Payment</a></ul>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    function afterPageLoad() {
      const ref = window.location.search;
      const query_string = ref.split('reference=');

      try {
        let ref_obj = atob(decodeURIComponent(query_string[1]));
        ref_obj = JSON.parse(ref_obj);
        console.log(JSON.stringify(ref_obj));
        const hasValidAmount = !isNaN(ref_obj.amount) && ref_obj.amount > 0;
        const hasPaymentId = ref_obj.paymentId && ref_obj.paymentId !== "undefined";
        const isPaymentSuccess = ref_obj.paymentStatus && ref_obj.paymentStatus.toLowerCase() === "payment approved";

        if (hasValidAmount && isPaymentSuccess) {
          // Show success section
          if(hasPaymentId){
                document.getElementById("paymentDiv").style.display = "block";
                document.getElementById("successUI").style.display = "block";
              document.getElementById("paymentId").innerHTML = ref_obj.paymentId;
          }else{
            document.getElementById("paymentDiv").style.display = "none";
          }
          

          const amt = new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD' }).format(ref_obj.amount);
          document.getElementById("amount").innerHTML = amt;

          document.getElementById("paymentResponse").innerHTML = ref_obj.paymentResponse;

          
          if (ref_obj.installPeriod) {
            document.getElementById("recurringInfo").style.display = "block";
            document.getElementById("installPeriod").innerHTML = ref_obj.installPeriod;
            document.getElementById("amnt").classList.add("half");
          }

          if (ref_obj.establishmentDate) {
            document.getElementById("establishmentDate").innerHTML = ref_obj.establishmentDate;
          }

          if (ref_obj.nextInstallmentDate) {
            document.getElementById("nextInstallmentDate").innerHTML = ref_obj.nextInstallmentDate;
          }

        } else {
          // Show error section
          document.getElementById("errorUI").style.display = "block";
          document.getElementById("successUI").style.display = "none";
          document.getElementById("paymentResponseErr").innerText = ref_obj.paymentResponse || "An unexpected error occurred.";

          if (ref_obj.retryURL) {
            document.getElementById("retryBtn").href =  ref_obj.retryURL 
          }
        }
      } catch (error) {
        document.getElementById("errorUI").style.display = "block";
        document.getElementById("successUI").style.display = "none";
        document.getElementById("paymentResponseErr").innerText = "Invalid or missing receipt data.";
        console.error("Failed to decode payment reference:", error);
      }
    }
  </script>
</body>
</html>