<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matruchhaya | Receipt</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      padding: 30px;
      margin: 0;
    }

    .container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 30px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 6px;
    }

    .logo {
      max-width: 150px;
      width: 100%;
      display: block;
      margin: 0 auto 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
    }

    h1.success {
      color: #2E8B57;
    }

    h1.error {
      color: #d9534f;
    }

    .section {
      margin-top: 20px;
    }

    .section h2 {
      font-size: 1.2em;
      margin-bottom: 10px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }

    .section p {
      margin: 8px 0;
    }

    .half {
      width: 48%;
      display: inline-block;
      vertical-align: top;
    }

    .note {
      margin-top: 30px;
      font-size: 0.9em;
      color: #555;
      text-align: center;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    #retryBtn a {
      color: #d9534f;
      text-decoration: underline;
    }

    #retryBtn {
      margin-top: 20px;
      text-align: center;
    }

    .hidden {
      display: none;
    }

    .error-message {
      color: #d9534f;
      font-weight: bold;
      text-align: center;
      margin-top: 10px;
    }

    .success-section, .error-section {
      display: none;
    }

    .icon {
      font-size: 40px;
      text-align: center;
    }

    .icon.success {
      color: #2E8B57;
    }

    .icon.error {
      color: #d9534f;
    }

    /* ✅ Mobile responsiveness */
    @media (max-width: 600px) {
      .half {
        width: 100%;
        display: block;
      }

      .container {
        padding: 20px;
      }

      .logo {
        max-width: 120px;
      }
    }
  </style>
</head>
<body onload="afterPageLoad()">

  <div class="container">
    <a href='https://wired-apps.github.io/sb.matruchhaya/donate'><img src="https://i0.wp.com/matruchhaya.org.au/wp-content/uploads/2025/08/MC-Logo.webp?w=545&ssl=1" alt="Matruchhaya Logo" class="logo"></a>

    <!-- Success UI -->
    <div class="success-section" id="successUI">
      <h1 class="success">Thank You for Your Gift</h1>

      <div class="section">
        <h2>Receipt Summary</h2>
        <p><strong>Payment ID:</strong> <span id="paymentId"></span></p>
        <p id="amnt"><strong>Amount:</strong> <span id="amount"></span></p>
        <p><strong>Response:</strong> <span id="paymentResponse"></span></p>
      </div>

      <div class="section hidden" id="period">
        <h2>Recurring Gift Info</h2>
        <p><strong>Frequency:</strong> <span id="installPeriod"></span></p>
      </div>

      <div class="section hidden" id="establishdate">
        <p><strong>Start Date:</strong> <span id="establishmentDate"></span></p>
      </div>

      <div class="section hidden" id="nextdate">
        <p><strong>Next Installment Date:</strong> <span id="nextInstallmentDate"></span></p>
      </div>

      <div class="note">
        We have sent the receipt to your inbox. <br>
        If you have questions, please contact our support team.
      </div>
    </div>

    <!-- Error UI -->
    <div class="error-section" id="errorUI">
      <div class="icon error">⚠️</div>
      <div class="error-message" id="errorMsg">Your donation could not be processed</div>
      <div class="note">
        <p><strong>Reason:</strong> <span id="paymentResponseErr"></span></p>
      </div>

      <div id="retryBtn">
        
      </div>
    </div>
  </div>

  <script type="text/javascript">
    function afterPageLoad() {
      const ref = window.location.search;
      const query_string = ref.split('reference=');

      try {
        let ref_obj = atob(decodeURIComponent(query_string[1]));
        ref_obj = JSON.parse(ref_obj);
        console.log(JSON.stringify(ref_obj));
        const hasValidAmount = !isNaN(ref_obj.amount) && ref_obj.amount > 0;
        const hasPaymentId = ref_obj.paymentId && ref_obj.paymentId !== "undefined";
        const isPaymentSuccess = ref_obj.paymentStatus && ref_obj.paymentStatus.toLowerCase() === "payment approved";

        if (hasValidAmount && isPaymentSuccess) {
          // Show success section
          document.getElementById("successUI").style.display = "block";
          if(hasPaymentId){
            document.getElementById("paymentId").innerHTML = ref_obj.paymentId;
          }
          const amt = new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD' }).format(ref_obj.amount);
          document.getElementById("amount").innerHTML = amt;

          document.getElementById("paymentResponse").innerHTML = ref_obj.paymentResponse;

         
          if (ref_obj.installPeriod) {
            document.getElementById("period").style.display = "block";
            document.getElementById("installPeriod").innerHTML = ref_obj.installPeriod;
            document.getElementById("amnt").classList.add("half");
          }

          if (ref_obj.establishmentDate) {
            document.getElementById("establishdate").style.display = "block";
            document.getElementById("establishmentDate").innerHTML = ref_obj.establishmentDate;
          }

          if (ref_obj.nextInstallmentDate) {
            document.getElementById("nextdate").style.display = "block";
            document.getElementById("nextInstallmentDate").innerHTML = ref_obj.nextInstallmentDate;
          }

        } else {
          // Show error section
          document.getElementById("errorUI").style.display = "block";
          document.getElementById("paymentResponseErr").innerText = ref_obj.paymentResponse || "An unexpected error occurred.";

          if (ref_obj.retryURL) {
            //document.querySelector("#retryBtn").innerHTML = "<ul><li><a href='" + ref_obj.retryURL + "'>Retry Payment</a></li></ul>";
            document.getElementById("retryBtn").innerHTML = "<ul><li><a href='" + ref_obj.retryURL + "'>Retry Payment</a></li></ul>";
          }
        }
      } catch (error) {
        document.getElementById("errorUI").style.display = "block";
        document.getElementById("paymentResponseErr").innerText = "Invalid or missing receipt data.";
        console.error("Failed to decode payment reference:", error);
      }
    }
  </script>
</body>
</html>

